<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <style>

    body{
        background-color: #494949;
        color: white;
    }
    #srchelem{
        margin: 50vh 3rem auto 2rem;
    }

    </style>
</head>
<body>
    <div id="rowgroup">
        <div id="srchelem">
            <label for="search">Search for a city...</label>
            <input type="search" id="search" name="search"/>
            <!-- <button class="go">Search</button> -->
        </div>
        <div id="resultwrapper">
            <img id="weather-icon" src="icons/0.png" alt="Weather icon">
        </div>
    </div>
</body>
<script>
/*
WMO Weather interpretation codes (WW)
Code Description
0 Clear sky
1, 2, 3 Mainly clear, partly cloudy, and overcast
45, 48 Fog and depositing rime fog
51, 53, 55 Drizzle: Light, moderate, and dense intensity
56, 57 Freezing Drizzle: Light and dense intensity
61, 63, 65 Rain: Slight, moderate and heavy intensity
66, 67 Freezing Rain: Light and heavy intensity
71, 73, 75 Snow fall: Slight, moderate, and heavy intensity
77 Snow grains
80, 81, 82 Rain showers: Slight, moderate, and violent
85, 86 Snow showers slight and heavy
95 * Thunderstorm: Slight or moderate
96, 99 * Thunderstorm with slight and heavy hail
*/
const searchInput = document.querySelector('#search');
const go = document.querySelector('.go');
const wmodict = {
  0: "Clear Sky",
  1: "Mainly Clear",
  2: "Partly Cloudy",
  3: "Overcast",
  45: "Fog",
  48: "Depositing Rime Fog",
  51: "Light Drizzle",
  53: "Moderate Drizzle",
  55: "Dense Drizzle",
  56: "Light Freezing Drizzle",
  57: "Dense Freezing Drizzle",
  61: "Slight Rain",
  63: "Moderate Rain",
  65: "Heavy Rain",
  66: "Light Freezing Rain",
  67: "Heavy Freezing Rain",
  71: "Slight Snowfall",
  73: "Moderate Snowfall",
  75: "Heavy Snowfall",
  77: "Snow Grains",
  80: "Slight Rain Showers",
  81: "Moderate Rain Showers",
  82: "Violent Rain Showers",
  85: "Slight Snow Showers",
  86: "Heavy Snow Showers",
  95: "Slight Or Moderate Thunderstorm",
  96: "Thunderstorm With Slight Hail",
  99: "Thunderstorm With Heavy Hail"
};
let lat;
let long;
let wcode; 
let percprob; 
let percsize; 
let tempfeel; 
let temp; 
let vis; 
let winddir; 
let windspeed; 
let humid;
let geoapi;
let weatherapi;
// $(".go").click(async function(){
//     Search();
// });

$(document).on('keydown', function (e) {
  if (e.key === 'Enter') {
    Search();
  }
});

$("input").blur(function(){
  Search();
});

function Search(){
    console.log(searchInput.value);
    geoapi = `https://geocoding-api.open-meteo.com/v1/search?name=${searchInput.value}&count=1&language=en&format=json`;
    console.log(geoapi);
    getGeo();
}


async function getGeo() {
    const answ = await fetch(geoapi);
    const location = await answ.json();
    lat = location.results[0].latitude;
    long = location.results[0].longitude;
    getWeather();
}


async function getWeather() {
    weatherapi = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${long}&hourly=precipitation_probability,precipitation,weather_code,apparent_temperature,visibility,wind_direction_10m,wind_speed_10m,temperature_2m,relative_humidity_2m&timezone=auto&forecast_days=1`;
    const answ = await fetch(weatherapi);
    const forecast = await answ.json();
    wcode = forecast.hourly.weather_code[7]; // fetching each value at 8am
    percprob = forecast.hourly.precipitation_probability[7];
    percsize = forecast.hourly.precipitation[7]; 
    tempfeel = forecast.hourly.apparent_temperature[7]; 
    temp = forecast.hourly.temperature_2m[7]; 
    vis = forecast.hourly.visibility[7]; 
    winddir = forecast.hourly.wind_direction_10m[7]; 
    windspeed = forecast.hourly.wind_speed_10m[7]; 
    humid = forecast.hourly.relative_humidity_2m[7];
    console.log(`Weather: ${wmodict[wcode]}
    Precipitation Probability: ${percprob}%`)
    Display();
}
function Display(){
    if (wcode == 0) {
        iconname = "icons/0.png";
    } 
    else if (wcode == 1 || wcode == 2) {
        iconname = "icons/1,2.png";
    }
    else if (wcode == 3) {
        iconname = "icons/3.png";
    }
    else if (wcode == 45 || wcode == 48) {
        iconname = "icons/45,48.png";
    }
    else if (wcode == 51 || wcode == 53 || wcode == 55) {
        iconname = "icons/51,53,55.png";
    }
    else if (wcode == 56 || wcode == 57) {
        iconname = "icons/56,57.png";
    }
    else if (wcode == 61 || wcode == 63 || wcode == 65) {
        iconname = "icons/61,63,65.png";
    }
    else if (wcode == 66 || wcode == 67) {
        iconname = "icons/66,67.png";
    }
    else if (wcode == 71 || wcode == 73 || wcode == 75) {
        iconname = "icons/71,73,75.png";
    }
    else if (wcode == 77) {
        iconname = "icons/77.png";
    }
    else if (wcode == 80 || wcode == 81 || wcode == 82) {
        iconname = "icons/80,81,82.png";
    }
    else if (wcode == 85 || wcode == 86) {
        iconname = "icons/85,86.png";
    }
    else if (wcode == 95) {
        iconname = "icons/95.png";
    }
    else if (wcode == 96 || wcode == 99) {
        iconname = "icons/96,99.png";
    }

    $('#weather-icon').attr('src', iconname);
    const resultwrapper = document.querySelector('#resultwrapper');
    resultwrapper.innerHTML = `
    <h2>Weather in ${searchInput.value} at 8 AM</h2>
    <img id="weather-icon" src="icons/${wcode}.png" alt="Weather icon">
    <p><strong>Condition:</strong> ${wmodict[wcode]}</p>
    <p><strong>Temperature:</strong> ${temp}°C (Feels like ${tempfeel}°C)</p>
    <p><strong>Precipitation Probability:</strong> ${percprob}%</p>
    <p><strong>Precipitation Amount:</strong> ${percsize} mm</p>
    <p><strong>Visibility:</strong> ${vis} meters</p>
    <p><strong>Wind:</strong> ${windspeed} km/h at ${winddir}°</p>
    <p><strong>Humidity:</strong> ${humid}%</p>
    `;
}
</script>
</html>