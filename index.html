<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Weather App</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

        <style>
            @media (max-width: 599px) {
                #rowgroup {
                    height: 100%;
                    display: flex;
                    flex-direction: column !important;
                    align-items: center;
                    justify-content: flex-start;
                }
                #srchelem {
                    width: 90%;
                    margin: 0 3rem 0 3rem;
                    display: flex;
                    flex-direction: column;
                    align-items: flex-start;
                    justify-content: center;
                    text-align: center;
                }
                #search {
                    background-color: transparent;
                    border: none;
                    border-bottom: 0.2rem solid rgb(255, 231, 48);
                    outline: none;
                    color: white;
                    text-transform: uppercase;
                    text-align: center;
            }
                #resultwrapper {
                    width: 80vw;
                    align-items: center;
                    display: flex;
                    flex-direction: column;
                }
            }
        
            body {
                font-family: Arial, Helvetica, sans-serif;
                background-color: #383838;
                color: white;
                margin: 0;
                padding: 0;
                height: 100%;
                overflow-x: hidden;
            }


            @media (min-width: 600px) {
                #srchelem {
                    width: 30vw;
                    margin: 0 3rem 0 4rem;
                    display: flex;
                    flex-direction: column;
                    align-items: flex-start;
                    justify-content: center;
                }   
                #rowgroup {
                    height: 100vh;
                    display: flex;
                    flex-direction: row;
                    align-items: center;
                    justify-content: flex-start;
                }
                #resultwrapper {
                    width: 60vw;
                    align-items: center;
                    display: flex;
                    flex-direction: column;
                }
                #timeslidercontainer {
                    align-self: flex-start !important;
                }
            }
            #weather-icon {
                margin-top: 2rem;
                width: 20rem;
            }
            #weatherntemp {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: center;
            }
            #divider {
                margin: 0 2rem;
            }

            #srchelem p,
            #search {
                font-size: 2.5rem;
                color: rgb(151, 151, 151);
                width: 100%;
            }

            #search {
                background-color: transparent;
                border: none;
                border-bottom: 0.2rem solid rgb(255, 231, 48);
                outline: none;
                color: white;
                text-transform: uppercase;
            }
            #windnhumi {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: flex-start; 
                gap: 0.5rem;
                
            }
            p{
                margin:1.5rem;
            }

            #wind {
                min-width: 7rem;             
                text-align: center;
            }
            .slider {
                height: 1.28rem;
                width: 8rem;
                background-color:#979797;
            }
            #timeslidercontainer {
                align-self: center;
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 1rem;
                
            }
            .scale:hover {
                color: grey;
                cursor: pointer;
            }

            #windicon:hover {
                content: "";
            }
            #time{
                display: inline-block;
                width: 4ch !important;
                margin-right: 1rem;
               
            }
            #myRange::-moz-range-track {
                -webkit-appearance: none; 
                appearance: none;
               
            }
            
            #myRange::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none; 
                height: 1.28rem;
                width: 16%;
                background-color: #fff;
                border-radius: 0%;
                border:none;
                
            }

            #myRange::-moz-range-thumb {
                height: 1.28rem;
                width: 16%;
                background-color: #ffe730;
                border-radius: 0%;
                border:none;
                
            }
        </style>
    </head>
    <body>
        <div id="rowgroup">
            <div id="srchelem">
                <p class="label1">Weather at</p>
                <div id="timeslidercontainer">
                    <p class="label1" id="time">8AM</p>
                    <input
                        type="range"
                        min="5"
                        max="10"
                        value="8"
                        class="slider"
                        id="myRange"
                    />
                </div>
                <p class="label1">in...</p>
                <input type="text" id="search" name="text" />

                <!-- <button class="go">Search</button> -->
            </div>
            <div style="display: none" id="resultwrapper">
                <!-- <h2
                    style="color: rgb(255, 231, 48); margin: none"
                    id="cityname"
                ></h2> -->
                <img id="weather-icon" src="icons/0.png" alt="Weather icon" />
                <div id="weatherntemp">
                    <h1 id="temp"></h1>
                    <h1 class="scale" id="scale"></h1>
                    <h1 id="divider">|</h1>
                    <h1 id="weather"></h1>
                </div>
                <div id="windnhumi">
                    
                    <h2 id="humidity"></h2>
                    <img
                        src="icons/drop.png"
                        alt="Humidity icon"
                        style="width: 2rem; vertical-align: middle"
                    />
                    <h2 id="wind"></h2>
                    <img
                        id="windicon"
                        class="windiconpos"
                        src="icons/winddir.png"
                        alt="Wind direction icon"
                        style="
                            width: 2rem;
                            vertical-align: middle;
                            margin-right: 2rem;
                        "
                    />
                </div>
            </div>
        </div>
    </body>
    <script>
        /*
WMO Weather interpretation codes (WW)
Code Description
0 Clear sky
1, 2, 3 Mainly clear, partly cloudy, and overcast
45, 48 Fog and depositing rime fog
51, 53, 55 Drizzle: Light, moderate, and dense intensity
56, 57 Freezing Drizzle: Light and dense intensity
61, 63, 65 Rain: Slight, moderate and heavy intensity
66, 67 Freezing Rain: Light and heavy intensity
71, 73, 75 Snow fall: Slight, moderate, and heavy intensity
77 Snow grains
80, 81, 82 Rain showers: Slight, moderate, and violent
85, 86 Snow showers slight and heavy
95 * Thunderstorm: Slight or moderate
96, 99 * Thunderstorm with slight and heavy hail
*/
        let lastpos = 0;
        let windAnimId = null;
        let morntime = 8;
        //const cityname = document.querySelector("#cityname");
        const searchInput = document.querySelector("#search");
        const go = document.querySelector(".go");
        const wmodict = {
            0: "Clear Sky",
            1: "Mainly Clear",
            2: "Partly Cloudy",
            3: "Overcast",
            45: "Fog",
            48: "Depositing Rime Fog",
            51: "Light Drizzle",
            53: "Moderate Drizzle",
            55: "Dense Drizzle",
            56: "Light Freezing Drizzle",
            57: "Dense Freezing Drizzle",
            61: "Slight Rain",
            63: "Moderate Rain",
            65: "Heavy Rain",
            66: "Light Freezing Rain",
            67: "Heavy Freezing Rain",
            71: "Slight Snowfall",
            73: "Moderate Snowfall",
            75: "Heavy Snowfall",
            77: "Snow Grains",
            80: "Slight Rain Showers",
            81: "Moderate Rain Showers",
            82: "Violent Rain Showers",
            85: "Slight Snow Showers",
            86: "Heavy Snow Showers",
            95: "Slight Or Moderate Thunderstorm",
            96: "Thunderstorm With Slight Hail",
            99: "Thunderstorm With Heavy Hail",
        };
        let lat, long, wcode, percprob, percsize, tempfeel, temp, vis, winddir, windspeed, humid, geoapi, weatherapi, lastSearch, pos, target; //tohle jsem delal pred tim nez jsem se dozvedel ze globalni promennou muzu udelat pomoci var
        let currentUnit = "C";
        // $(".go").click(async function(){
        //     Search();
        // });
        const tempdisplay = document.querySelector("#temp");
        const scale = document.querySelector("#scale");
         const $slider = $("#myRange");
        $slider.val(7);

        $("#scale").on("click", function () {
            if (currentUnit === "C") {
                let tempf = (temp * 9) / 5 + 32;
                tempdisplay.textContent = `${tempf.toFixed(1)}째`;
                scale.textContent = "F";
                currentUnit = "F";
            } else {
                tempdisplay.textContent = `${temp}째`;
                scale.textContent = "C";
                currentUnit = "C";
            }
        });

        $(document).on("keydown", function (e) {
            if (e.key === "Enter") {
                Search();
            }
        });

        $("#search").blur(function () {
            Search();
        });

        $("#search").focus(function () {
            $(this).val("");
        });

        $("#myRange").on("input", function () {
            morntime = Number(this.value);
            console.log(morntime);

            const times = ["5AM", "6AM", "7AM", "8AM", "9AM", "10AM"];
            const timeLabelElement = document.querySelector("#time");
            console.log(timeLabelElement);
            timeLabelElement.textContent = times[morntime - 5];
            if (searchInput.value !== "") {
                getWeather();
            }
        });
       
        function Search() {
            
            if (Boolean(searchInput.value) && searchInput.value !== lastSearch) {
                console.log(searchInput.value);
                geoapi = `https://geocoding-api.open-meteo.com/v1/search?name=${searchInput.value}&count=1&language=en&format=json`;
                console.log(geoapi);
                getGeo();
                lastSearch = searchInput.value;
            }
        }

        async function getGeo() {
            const answ = await fetch(geoapi);
            const location = await answ.json();
            if(Boolean(location.results)){
                lat = location.results[0].latitude;
                long = location.results[0].longitude;
            }
            else{
                alert("Location not found. Please try again.");
                
            }

            getWeather();
        }

        async function getWeather() {
            // let file = "abc.json"
            weatherapi = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${long}&hourly=precipitation_probability,precipitation,weather_code,apparent_temperature,visibility,wind_direction_10m,wind_speed_10m,temperature_2m,relative_humidity_2m&timezone=auto&forecast_days=1`;
            const answ = await fetch(weatherapi);
            // const answ = await fetch(file);
            const forecast = await answ.json();
            wcode = forecast.hourly.weather_code[morntime]; // fetching each value at 8am
            percprob = forecast.hourly.precipitation_probability[morntime];
            percsize = forecast.hourly.precipitation[morntime];
            tempfeel = forecast.hourly.apparent_temperature[morntime];
            temp = forecast.hourly.temperature_2m[morntime];
            vis = forecast.hourly.visibility[morntime];
            winddir = forecast.hourly.wind_direction_10m[morntime];
            windspeed = forecast.hourly.wind_speed_10m[morntime];
            humid = forecast.hourly.relative_humidity_2m[morntime];
            console.log(`Weather: ${wmodict[wcode]}
    Precipitation Probability: ${percprob}%`);
            Display();
        }

        function animation() {
                    if (pos === target) {
                        clearInterval(windAnimId);
                        windAnimId = null;
                        lastpos = target;
                        return;
                    }

                    if (pos < target && !(target - pos < 180)) {
                        pos++;
                    } 
                    else if (pos > target && !(pos - target < 180)) {
                            pos--;
                        }
                    else if (pos < target && target - pos < 180) {
                            pos++;
                        }
                    else if (pos > target && pos - target < 180) {
                            pos--;
                        }
                    
                    windicon.style.transform = `rotate(${pos}deg)`;
                    }

                

        function Display() {
            if (wcode == 0) {
                iconname = "icons/0.png";
            } else if (wcode == 1 || wcode == 2) {
                iconname = "icons/1,2.png";
            } else if (wcode == 3) {
                iconname = "icons/3.png";
            } else if (wcode == 45 || wcode == 48) {
                iconname = "icons/45,48.png";
            } else if (
                wcode == 51 ||
                wcode == 53 ||
                wcode == 55 ||
                wcode == 56 ||
                wcode == 57
            ) {
                iconname = "icons/51,53,55,56,57.png";
            } else if (
                wcode == 61 ||
                wcode == 63 ||
                wcode == 65 ||
                wcode == 66 ||
                wcode == 67 ||
                wcode == 80 ||
                wcode == 81 ||
                wcode == 82
            ) {
                iconname = "icons/61,63,65,66,67,80,81,82.png";
            } else if (
                wcode == 71 ||
                wcode == 73 ||
                wcode == 75 ||
                wcode == 77 ||
                wcode == 85 ||
                wcode == 86
            ) {
                iconname = "icons/71,73,75,77,85,86.png";
            } else if (wcode == 95 || wcode == 96 || wcode == 99) {
                iconname = "icons/95,96,99.png";
            }

            $("#weather-icon").attr("src", iconname);
            const resultwrapper = document.querySelector("#resultwrapper");
            const weather = document.querySelector("#weather");
            const tempdisplay = document.querySelector("#temp");
            const scale = document.querySelector("#scale");
           
            // const diricon = document.querySelector('#windicon');
            // $("#windicon").hover(function(){

            // })
            weather.textContent = wmodict[wcode];
            //cityname.textContent = searchInput.value[0].toUpperCase() + searchInput.value.slice(1);
            resultwrapper.style.display = "flex";
            const wind = document.querySelector("#wind");
            wind.textContent = `${windspeed} km/h`;
            let heading;
            $("#wind").hover(function () {
                if(winddir > 0 && winddir < 22.5){
                    windFrom = "Southwest";
                }
                if(winddir >= 22.5 && winddir < 67.5){
                    windFrom = "West";
                }
                if(winddir >= 67.5 && winddir < 112.5){
                    windFrom = "Northwest";
                }
                if(winddir >= 112.5 && winddir < 157.5){
                    windFrom = "North";
                }
                if(winddir >= 157.5 && winddir < 202.5){
                    windFrom = "Northeast";
                }
                if(winddir >= 202.5 && winddir < 247.5){
                    windFrom = "East";
                }
                if(winddir >= 247.5 && winddir < 292.5){
                    windFrom = "Southeast";
                }
                if(winddir >= 292.5 && winddir < 337.5){
                    windFrom = "South";
                }
                if(winddir >= 337.5 && winddir <= 360){
                    windFrom = "Southwest";
                }

                wind.textContent = `From ${windFrom}`;
            }, function () {
                wind.textContent = `${windspeed} km/h`;
            });

            // windicon.style.transform = `rotate(${winddir+720}deg)`;
            Windmove();
            const humidity = document.querySelector("#humidity");
            humidity.textContent = `${humid}%`;
            if (currentUnit === "C") {
                    tempdisplay.textContent = `${temp}째`;
                    scale.textContent = "C";
                } else {
                    let tempf = (temp * 9) / 5 + 32;
                    tempdisplay.textContent = `${tempf.toFixed(1)}째`;
                    scale.textContent = "F";
                }
                
            function Windmove() {
                const windicon = document.querySelector("#windicon");
                if (!windicon) return;

                target = winddir;
                pos = lastpos;

                if (windAnimId !== null) {
                    clearInterval(windAnimId);
                    windAnimId = null;
                }

                windAnimId = setInterval(animation, 0.5); //this interval calls the function every 3 msec essentially making an animation 
            }

        }
    </script>
</html>
